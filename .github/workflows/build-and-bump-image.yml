name: Build & bump SVIM image

on:
  push:
    branches:
      - main
    # Evita loop quando o próprio Action altera só o agent.yml
    paths-ignore:
      - "workflows/_flows/svim/maria.yml"

jobs:
  build-and-bump:
    runs-on: ubuntu-latest
    permissions:
      contents: write # precisa para poder commitar de volta

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Bump version in maria.yml
        id: bump
        run: |
          FILE="workflows/_flows/svim/maria.yml"

          # Pega repo e versão atuais (ex: gmoreiradev/svim-maria:v0.0.2)
          line=$(grep 'containerImage:' "$FILE")
          repo=$(echo "$line" | sed -E 's/.*containerImage:[[:space:]]*([^:]+):v[0-9]+\.[0-9]+\.[0-9]+/\1/')
          current=$(echo "$line" | sed -E 's/.*:v([0-9]+\.[0-9]+\.[0-9]+)/\1/')
          echo "Current repo: $repo"
          echo "Current version: $current"

          IFS='.' read -r major minor patch <<< "$current"
          old_patch="$patch"
          patch=$((patch + 1))

          new_plain="${major}.${minor}.${patch}"
          new_version="v${new_plain}"

          echo "New version: $new_version"

          # Atualiza a linha do containerImage mantendo o repo detectado
          sed -i "s#containerImage: ${repo}:v${major}.${minor}.${old_patch}#containerImage: ${repo}:${new_version}#" "$FILE"

          # Exporta para os próximos steps
          echo "IMAGE_TAG=${new_version}" >> $GITHUB_ENV
          echo "IMAGE_NAME=${repo}" >> $GITHUB_ENV
          echo "image_tag=${new_version}" >> $GITHUB_OUTPUT
          echo "image_name=${repo}" >> $GITHUB_OUTPUT

      - name: Build & push image
        run: |
          echo "Building and pushing image with tag: $IMAGE_TAG"
          make build-image IMAGE_NAME="${IMAGE_NAME}" IMAGE_TAG="${IMAGE_TAG}"
          make push-image IMAGE_NAME="${IMAGE_NAME}" IMAGE_TAG="${IMAGE_TAG}"

      - name: Commit and push updated maria.yml
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [ -f workflows/_flows/svim/maria.yml ]; then
            git add workflows/_flows/svim/maria.yml
          else
            echo "❌ Arquivo workflows/_flows/svim/maria.yml não encontrado."
            exit 1
          fi

          git commit -m "chore: bump ${IMAGE_NAME} image to ${IMAGE_TAG} [skip ci]"
          git push

      - name: Trigger Kestra sync from git
        run: |
          curl -X POST "https://kestra.basixdigital.com.br/api/v1/executions/webhook/system/sync_files_from_git/sync" \
            -H "Content-Type: application/json" \
            -d '{}'
